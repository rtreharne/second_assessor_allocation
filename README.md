# Second Marker Allocation System

Tools for generating supervisor profiles and allocating second assessors fairly and automatically.

This repository contains two scripts:

- `build_supervisor_set.py` â€“ generates a unique supervisor set from **all_projects.csv**, merging keywords and project types across all projects supervised by each academic.
- `allocate_second_markers.py` â€“ allocates second assessors to allocated projects using a fairnessâ€‘first algorithm with TFâ€‘IDF topic matching.

---

## ðŸ“¦ Installation

It is strongly recommended to run everything inside a Python virtual environment.

### Windows (PowerShell)

```powershell
python -m venv .venv
.venvenv\Scripts\Activate.ps1
```

If activation is blocked:

```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process
```

Then activate again.

### Linux / macOS

```bash
python3 -m venv .venv
source .venv/bin/activate
```

### Install dependencies

```bash
pip install -r requirements.txt
```

`requirements.txt` should contain:

```
pandas
scikit-learn
```

---

## ðŸ“¥ Required Input Files

Place all CSV files in the same directory as the scripts.

### 1. `all_projects.csv`
- Exported from **canvaswizards.org.uk** (Projects App).
- Used by `build_supervisor_set.py` to construct the merged supervisor profile set.
- Must include the following headers:

| Column | Description |
|--------|-------------|
| `id` | Project ID |
| `primary_supervisor` | Supervisor username |
| `keywords` | Project keywords |
| `type` | Project type |
| `ug_or_pg` | UG or PG project |
| â€¦ | Additional fields are ignored |

### 2. `supervisor_set.csv`
Generated by `build_supervisor_set.py`.

Headers:

| Column | Description |
|--------|-------------|
| `username` | Supervisor username |
| `n_projects` | Number of projects they supervise |
| `merged_keywords` | All unique keywords across supervised projects |
| `merged_types` | All unique project types |

### 3. `projects.csv`
Contains **all allocated projects** that require a second assessor.

This also originates from **canvaswizards.org.uk** after allocation workflows are complete.

Required headers:

| Column | Description |
|--------|-------------|
| `Username` | Primary supervisor username |
| `keywords_project` | Keywords for the specific allocated project |
| `types_project` | Project type for the specific project |
| `id_project` | Project ID |
| `id_student` | Student ID |
| Other fields are allowed but unused |

### 4. `capacity.csv`
Contains marking capacity information for all assessors.

Required headers:

| Column | Description |
|--------|-------------|
| `Username` | Assessor username |
| `Forename` | First name |
| `Surname` | Last name |
| `Tot.Projects` | Number of projects they supervise |
| `Difference (can be used for extra 2nd marking)` | Additional secondâ€‘marking capacity |
| Other columns are ignored |

---

## ðŸ›  Workflow

### Step 1 â€” Build the supervisor set

```bash
python build_supervisor_set.py
```

Produces:

```
supervisor_set.csv
```

### Step 2 â€” Allocate second assessors

```bash
python allocate_second_markers.py
```

Produces:

- `projects_with_second_assessors.csv`  
  Contains project metadata and allocated second assessor information.

- `capacity_updated.csv`  
  Shows each assessorâ€™s:
  - supervised load  
  - secondâ€‘marking load  
  - remaining capacity  

---

## ðŸ§  Allocation Logic

Second assessor choices balance two factors:

1. **Fairness (55% weight)**  
   Prefers assessors with lowest current load.

2. **Match Quality (45% weight)**  
   TFâ€‘IDF comparison between:
   - project keywords & type  
   - assessor merged keywords & types  

### Additional rules enforced:
- No selfâ€‘marking  
- No assessor marks more than one project for the same supervisor  
- Capacity limits respected  
- No assessor exceeds `Tot.Projects + Difference`  

---

## âœ” Licence

Internal use for University of Liverpool Biosciences project allocation workflows.


---

## ðŸ§© Allocation Assumptions

The secondâ€‘marker allocation is based on the following explicit assumptions:

1. **Every project must receive exactly one second assessor**, unless no eligible assessor is available (result = `UNALLOCATED`).

2. **Fairness is the primary optimisation goal**.  
   Assessors with lower current workloads are preferred over higherâ€‘loaded assessors.

3. **Match quality is the secondary optimisation goal**.  
   TFâ€‘IDF similarity between project keywords/types and assessor merged keywords/types ranks candidates after fairness.

4. **Selfâ€‘marking is not allowed**.  
   A primary supervisor cannot be allocated as second assessor to their own project.

5. **No duplicate pairings**.  
   A second assessor cannot be assigned more than one project from the same primary supervisor.

6. **Capacity limits are strictly enforced**.  
   An assessor cannot be allocated beyond:
   ```
   max_second_mark = Tot.Projects + Difference
   ```

7. **Assessors with zero calculated capacity** are completely excluded from allocation.

8. **Keywords and types in all input files are treated as descriptive indicators** and not validated for subject accuracy.

9. **The allocation is greedy but fairnessâ€‘weighted**, not globally optimised.  
   It processes projects in the order in which they appear in `projects.csv`.

10. **Similarity does not imply staff qualification**, only topic proximity derived from text fields.

11. **Missing values** (blank keywords or types) are treated as empty strings.

12. **Final capacity usage** is computed only from actual allocations made by the script.

---

